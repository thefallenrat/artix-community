# Maintainer: Jameson Pugh <imntreal@gmail.com>

pkgbase=octopi
pkgname=('octopi' 'octopi-pacmanhelper' 'octopi-notifier-frameworks' 'octopi-repoeditor' 'octopi-cachecleaner')
pkgver=0.9.0
pkgrel=3
# This is the release package so the below _gitcommit variable should (usually) be commented out.
_gitcommit="52e111f5ab53b5b60ac06ca1cd47c70e0aced435"
pkgdesc="a powerful Pacman frontend using Qt libs"
arch=('i686' 'x86_64')
url="http://octopiproject.wordpress.com"
license=('GPL2')
makedepends=('qt5-declarative' 'git' 'knotifications' 'alpm_octopi_utils' 'qtermwidget')
if [ "${_gitcommit}" != "" ]; then
	source=("octopi-${pkgver}-${pkgrel}.tar.gz::https://github.com/aarnt/octopi/archive/${_gitcommit}.tar.gz"
	'octopi-repoeditor.desktop'
	transactiondialog.diff)
else
  source=("https://github.com/aarnt/${pkgname}/archive/v${pkgver}.tar.gz"
	'octopi-repoeditor.desktop'
	transactiondialog.diff)
fi
sha256sums=('fda4b2c532d8f398ea03bfaf44fa86ab3a1d9611e652b313807a3193ad5a7e56'
            '131f16745df685430db55e54ede6da66aed9b02ca00d6d873a002b2a3e1c90ef'
            '2d36c7ccc0235361bf105903281d05fe883559b6b34e550620faf9466aad9877')

prepare() {
  if [ "${_gitcommit}" != "" ]; then
    cd "${srcdir}/${pkgbase}-${_gitcommit}"
  else
	  cd "${srcdir}/${pkgbase}-${pkgver}"
  fi

	# sed version
  sed -i -e "s|0.9.0 (dev)|${pkgver}-${pkgrel}|g" src/strconstants.h

  cp -r notifier notifier-qt5
  cp -r notifier notifier-frameworks
	sed -i 's|#DEFINES += KSTATUS|DEFINES += KSTATUS|' notifier-frameworks/octopi-notifier/octopi-notifier.pro

	patch -Np 1 -i $srcdir/transactiondialog.diff
}

build() {
	if [ "${_gitcommit}" != "" ]; then
    cd "${srcdir}/${pkgbase}-${_gitcommit}"
	else
  	cd "${srcdir}/${pkgbase}-${pkgver}"
	fi

	msg "Building octopi..."
	qmake-qt5 octopi.pro
	make

	cd notifier/pacmanhelper
	msg "Building pacmanhelper..."
	qmake-qt5 pacmanhelper.pro
	make

# 	cd ../../notifier-qt5/octopi-notifier
# 	msg "Building octopi-notifier-qt5..."
# 	qmake-qt5 octopi-notifier.pro
# 	make

	cd ../../notifier-frameworks/octopi-notifier
	msg "Building octopi-notifier-frameworks..."
	qmake-qt5 octopi-notifier.pro
	make

	cd ../../repoeditor
	msg "Building octopi-repoeditor..."
	qmake-qt5 octopi-repoeditor.pro
	make

	cd ../cachecleaner
	msg "Building octopi-cachecleaner..."
	qmake-qt5 octopi-cachecleaner.pro
	make
}

package_octopi() {
	pkgdesc="A powerful Pacman frontend using Qt5 libs"
	depends=('qt5-declarative' 'alpm_octopi_utils' 'qtermwidget')
	optdepends=('xterm: for AUR support'
				'kdesu: for KDE'
		    'gksu: for XFCE, Gnome, LXDE, Cinnamon'
				'lxqt-sudo: for LXQT'
		    'gnome-keyring: for password management'
		    'gist: for SysInfo report'
		    'pacaur: for AUR support'
		    'yaourt: for AUR support'
		    'octopi-repoeditor: for editing functions'
		    'octopi-cachecleaner: for cleaning functions'
		    'octopi-notifier-qt5: for notifications'
		    'octopi-notifier-frameworks: for notifications'
		    'pacmanlogviewer: to view pacman log files')
	conflicts=('octopi-git')

	if [ "${_gitcommit}" != "" ]; then
    cd "${srcdir}/${pkgbase}-${_gitcommit}"
	else
		cd "${srcdir}/${pkgbase}-${pkgver}"
	fi

	install -D -m755 "bin/${pkgname}" "${pkgdir}/usr/bin/${pkgname}"
	install -D -m644 "${pkgname}.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"
	install -D -m644 "resources/images/${pkgname}_green.png" "${pkgdir}/usr/share/icons/${pkgname}.png"
	install -D -m644 "resources/images/${pkgname}_green.png" "${pkgdir}/usr/share/icons/gnome/32x32/apps/${pkgname}.png"
	install -D -m644 "resources/images/${pkgname}_red.png" "${pkgdir}/usr/share/icons/${pkgname}_red.png"
	install -D -m644 "resources/images/${pkgname}_yellow.png" "${pkgdir}/usr/share/icons/${pkgname}_yellow.png"

	#speedup files
	#install -D -m755 "speedup/speedup-octopi.sh" "${pkgdir}/usr/bin/speedup-octopi.sh"
	#install -D -m644 "speedup/${pkgname}.service" "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"
}

package_octopi-pacmanhelper() {
	pkgdesc="Pacman helper for Octopi notifier"
  depends=('qt5-base')

  if [ "${_gitcommit}" != "" ]; then
    cd "${srcdir}/${pkgbase}-${_gitcommit}"
  else
    cd "${srcdir}/${pkgbase}-${pkgver}"
  fi

  install -Dm755 "notifier/bin/pacmanhelper" "${pkgdir}/usr/lib/octopi/pacmanhelper"
	install -Dm644 "notifier/pacmanhelper/polkit/org.octopi.pacman.policy" "${pkgdir}/usr/share/polkit-1/actions/org.octopi.pacman.policy"
	install -Dm644 "notifier/pacmanhelper/polkit/org.octopi.pacmanhelper.conf" "${pkgdir}/etc/dbus-1/system.d/org.octopi.pacmanhelper.conf"
	install -Dm644 "notifier/pacmanhelper/polkit/org.octopi.pacmanhelper.xml" "${pkgdir}/usr/share/dbus-1/interfaces/org.octopi.pacmanhelper.xml"
	install -Dm644 "notifier/pacmanhelper/polkit/org.octopi.pacmanhelper.service" "${pkgdir}/usr/share/dbus-1/system-services/org.octopi.pacmanhelper.service"
}

# package_octopi-notifier-qt5() {
# 	pkgdesc="Notifier for Octopi using Qt5 libs"
# 	depends=('octopi-pacmanhelper' 'libnotify' 'qt5-base')
# 	optdepends=('xfce4-notifyd: for notifications in XFCE')
# 	conflicts=('octopi-notifier' 'octopi-notifier-qt4' 'octopi-notifier-frameworks')
# 	provides=('octopi-notifier')
# 	replaces=('octopi-notifier-qt4')
#
# 	if [ "${_gitcommit}" != "" ]; then
# 		cd "${srcdir}/${pkgbase}-${_gitcommit}"
# 	else
# 		cd "${srcdir}/${pkgbase}-${pkgver}"
# 	fi
#
# 	#Octopi-notifier files
# 	install -D -m755 "notifier-qt5/bin/octopi-notifier" "${pkgdir}/usr/bin/octopi-notifier"
# 	install -D -m644 "notifier-qt5/octopi-notifier/octopi-notifier.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"
# 	install -D -m644 "notifier-qt5/octopi-notifier/octopi-notifier.desktop" "${pkgdir}/etc/xdg/autostart/${pkgname}.desktop"
# }

package_octopi-notifier-frameworks() {
	pkgdesc="Notifier for Octopi with Knotifications support"
	depends=('octopi-pacmanhelper' 'libnotify' 'knotifications')
	optdepends=('xfce4-notifyd: for notifications in XFCE')
	conflicts=('octopi-notifier' 'octopi-notifier-qt4' 'octopi-notifier-qt5')
	provides=('octopi-notifier')
	replaces=('octopi-notifier')

	if [ "${_gitcommit}" != "" ]; then
		cd "${srcdir}/${pkgbase}-${_gitcommit}"
	else
		cd "${srcdir}/${pkgbase}-${pkgver}"
	fi

	#Octopi-notifier files
	install -D -m755 "notifier-frameworks/bin/octopi-notifier" "${pkgdir}/usr/bin/octopi-notifier"
	install -D -m644 "notifier-frameworks/octopi-notifier/octopi-notifier.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"
	install -D -m644 "notifier-frameworks/octopi-notifier/octopi-notifier.desktop" "${pkgdir}/etc/xdg/autostart/${pkgname}.desktop"
}

package_octopi-repoeditor() {
	pkgdesc="Pacman repo editor for Octopi"
	depends=('qt5-base')

	if [ "${_gitcommit}" != "" ]; then
  	cd "${srcdir}/${pkgbase}-${_gitcommit}"
	else
	  cd "${srcdir}/${pkgbase}-${pkgver}"
	fi

	#Octopi-repoeditor files
	install -D -m755 "repoeditor/bin/octopi-repoeditor" "${pkgdir}/usr/bin/octopi-repoeditor"
	install -D -m644 "${srcdir}/${pkgname}.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"
	install -D -m644 "resources/images/${pkgbase}_red.png" "${pkgdir}/usr/share/icons/${pkgname}.png"
}

package_octopi-cachecleaner() {
	pkgdesc="Cachecleaner for Octopi"
	depends=('qt5-base')

	if [ "${_gitcommit}" != "" ]; then
	  cd "${srcdir}/${pkgbase}-${_gitcommit}"
	else
		cd "${srcdir}/${pkgbase}-${pkgver}"
	fi

	#Octopi-cachecleaner files
	install -D -m755 "cachecleaner/bin/octopi-cachecleaner" "${pkgdir}/usr/bin/octopi-cachecleaner"
	install -D -m644 "cachecleaner/$pkgname.desktop" "${pkgdir}/usr/share/applications/$pkgname.desktop"
}

# vim: set ts=2 sw=2 ft=sh noet:
